# ShopWind的任意文件删除

供应商主页：https://www.shopwind.net/

软件链接：https://www.shopwind.net/product/download.html

影响版本：shopwind <= 3.4.2

## 1.漏洞分析

在网站后台测试数据库备份功能时,看到函数时请删除备份文件.因此,请分析此函数的代码.经过测试,发现存在任意文件删除漏洞.结合shopwind安装脚本,可以达到getshell的目的.接下来,开始分析代码

### 1.1定位漏洞入口点

poc示例

```sql
http://local.rapoo.top/admin/db/delete.html?backup_name=filename
```

根据链接分析，可以将路由对应的文件定位为PHP中的后端dbcontroller Actiondelete方法，文件为 \backend\controllers\DbController.php 

打开该文件并找到操作删除方法。代码如下：

从代码中可以看出，此方法主要用于删除备份

```php
	/**
	 * 删除备份
	 */
	public function actionDelete()
	{
		$post = Basewind::trimAll(Yii::$app->request->get(), true);
		if(empty($post->backup_name)){
			return Message::warning(Language::get('no_select'));
		}
		$backup_names = explode(',', $post->backup_name);
		foreach ($backup_names as $backup_name)
        {
			$model = new \backend\models\DbForm();
			$model->deleteBackup($backup_name);
        }
		return Message::display(Language::get('drop_ok'));
	}
```

### 1.2 代码分析

![image](https://user-images.githubusercontent.com/54017627/168499533-da0b8836-69be-46c1-b4f0-d392f882e3e0.png)

在代码的开头，使用 Yii::$app - > 请求 - > get() 获取 get 的所有参数，然后使用 trimall 处理获取的参数。在这里，我们跟踪trimall的代码，看看函数将如何处理它

代码在\common\library\basewind.php 文件中

![image](https://user-images.githubusercontent.com/54017627/168499605-acd36ff2-3362-4fc4-9837-e9e387c127a6.png)

这个函数的功能非常简单。首先，默认情况下传入的所有值都将是 de 空格，然后传入的 $intvalfields 数组中的每个参数都将转换为整数。因为在这里调用这个函数不会传入$intvalfields数组，也就是说，get 获得的所有内容都只是 de 空格。然后继续分析

![image](https://user-images.githubusercontent.com/54017627/168499621-fd60c608-a299-4d7e-8c0e-b1b9b53cddea.png)

然后，它将判断传入的值是否为空。如果为空，它将返回一条警告消息。此值可以直接传递

![image](https://user-images.githubusercontent.com/54017627/168499629-f0735e2f-0523-4b24-ba0f-8b7927994001.png)

在这里，逗号用作分隔符，将传入的内容划分为数组

![image](https://user-images.githubusercontent.com/54017627/168499642-8770d6b0-1282-4088-9d1d-6b182d80423a.png)

然后遍历文件名数组，创建一个dbform对象，最后调用该对象的deletebackup方法来删除文件。

### 1.3 分析删除备份功能
我们跟踪了删除备份方法，文件路径为 \backend\models\DbForm.php

![image](https://user-images.githubusercontent.com/54017627/168499709-47856b22-b1c4-4185-b1f9-1e176709fc42.png)

![image](https://user-images.githubusercontent.com/54017627/168499715-cbd47586-568d-4378-824e-705674b223bc.png)

这里先调用 getbackuppath 方法，然后跟进查看函数

![image](https://user-images.githubusercontent.com/54017627/168499735-a370837b-3906-4f6f-a023-44a2ff486a45.png)

通过拼接传入值和前端/Web/数据，获取文件的绝对路径。关键点在这里。这里直接使用 用户传入的值与网站前端的根目录拼接，传入的值不被检测和过滤，所以我们可以使用/跳转到任何目录，导致任意文件删除漏洞

![image](https://user-images.githubusercontent.com/54017627/168499748-46b783f9-cfc7-474c-88c9-ee70f438d89b.png)

判断获取的路径是否为文件夹。如果是文件夹，遍历文件夹下的文件，调用unlink逐个删除，最后使用rmdir函数删除文件夹

![image](https://user-images.githubusercontent.com/54017627/168499760-0fbd1e17-2a4a-4eaa-8252-44dae5a1e2fb.png)

如果获取的路径是文件，请直接将其删除

## 2. 漏洞复现

### 2.1 在当地建立良好的环境
![image](https://user-images.githubusercontent.com/54017627/168500154-e776da12-9a83-4b52-b1e2-96edb250b560.png)

### 2.2 构造POC并删除install.lock

网站安装完毕后，安装锁文件在数据目录中，我们需要删除的备份文件也在数据directory_备份目录的SQL中，所以我们只需要使用/就可以跳转到数据目录

![image](https://user-images.githubusercontent.com/54017627/168500135-157ce39f-499e-4f37-a773-58210bb19c81.png)

poc:
```
http://local.rapoo.top/admin/db/delete.html?backup_name=../install.lock
```

### 2.3 删除文件

![image](https://user-images.githubusercontent.com/54017627/168500119-bf94cfd0-88f3-444b-a869-69a28a894616.png)

![image](https://user-images.githubusercontent.com/54017627/168500122-b44b59b2-76e3-40b3-a9c6-2e7ad77cde55.png)

删除文件成功

### 2.4 重新安装网站

再次请求网站首页后，会跳转到安装页面

![image](https://user-images.githubusercontent.com/54017627/168500104-d534024b-f94f-4a19-9601-48502c97a6df.png)

![image](https://user-images.githubusercontent.com/54017627/168500109-a7da3933-5b0e-4e36-b078-116d49e342da.png)

