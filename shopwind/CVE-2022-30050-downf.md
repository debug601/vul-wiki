# ShopWind的任意文件下载

供应商主页：https://www.shopwind.net/

软件链接：https://www.shopwind.net/product/download.html

影响版本：shopwind <= 3.4.2

## 1. 漏洞分析
备份数据库后，发现备份文件可以直接下载，因此分析了备份下载功能
![image](https://user-images.githubusercontent.com/54017627/168498876-bcdb0dcb-75a2-4407-a7ef-3a09078ca96a.png)



### 1.1 定位漏洞入口点
通过分析路由，得到文件入口点为\backend\controllers\DbController.php
![image](https://user-images.githubusercontent.com/54017627/168498866-baeee7b2-976c-416f-a9c0-3e895e643234.png)


## 1.2代码分析

```php
	/**
	 * 下载备份
	 */
	public function actionDownload()
	{
		$post = Basewind::trimAll(Yii::$app->request->get(), true);
		if(empty($post->file)){
			return Message::warning(Language::get('no_such_file'));
		}
		if(empty($post->backup_name)){
			return Message::warning(Language::get('no_backup_name'));
		}
		$model = new \backend\models\DbForm();
		if(!$model->downloadBackup($post->backup_name,$post->file)){
			return Message::warning(Language::get('no_such_file'));
		}
	}
```

![image](https://user-images.githubusercontent.com/54017627/168498895-2e4e345c-52e2-417c-a893-41312f7cc985.png)

在 start 中，代码使用 Yii::$app->request->get() 获取所有 get 参数，然后使用 trimall 来处理获取的参数。在这里，让我们跟踪trimall的代码，看看函数将如何处理它。 
文件中 \common\library\Basewind.php的代码

![image](https://user-images.githubusercontent.com/54017627/168498899-873156ae-2930-4f1d-a9b4-604c04e31bba.png)

这个函数的功能非常简单。首先，默认情况下传入的所有值都将是 de 空格，然后传入的 $intvalfields 数组中的每个参数都将转换为整数。因为在这里调用这个函数不会传入$intvalfields数组，也就是说，get 获得的所有内容都只是 de 空格。然后继续分析

![image](https://user-images.githubusercontent.com/54017627/168498908-bc77f5f8-c6fd-4d41-84cb-015f29ab410d.png)

![image](https://user-images.githubusercontent.com/54017627/168498911-cfebdda4-87b0-4276-84cf-c293784b4edf.png)

然后，它将判断传入的值是否为空。如果为空，它将返回一条警告消息。此值可以直接传递

![image](https://user-images.githubusercontent.com/54017627/168498920-a6094013-23eb-496a-a10a-e1e8ebddd8aa.png)

创建一个dbform对象，最后调用该对象的downloadbackup方法来下载文件

### 1.3 分析下载备份功能

对于此文件,我们跟踪备份 \backend\models\DbForm.php

![image](https://user-images.githubusercontent.com/54017627/168499000-1252f77c-f65c-4f78-b978-e42bc05386f4.png)

```sql
	/* 下载备份文件 */
	public function downloadBackup($backup_name,$file)
	{
		$path = $this->getBackUpPath() . DIRECTORY_SEPARATOR . $backup_name . DIRECTORY_SEPARATOR . $file;
		if(file_exists($path)){
			header('Content-type: application/unknown');
            header('Content-Disposition: attachment; filename="'. $file. '"');
            header("Content-Length: " . filesize($path) ."; ");
            readfile($path);
            exit(0);
		}
		
		return false;
	}
```

![image](https://user-images.githubusercontent.com/54017627/168499028-65b22513-5c04-46e2-b4e4-1aef6357ee09.png)

这里，首先调用 getbackuppath 方法，使用Backup_ Name 文件夹和文件名拼接，没有任何过滤 接下来，跟踪 getbackuppath 方法

![image](https://user-images.githubusercontent.com/54017627/168499047-17e0c3fb-dec0-496a-8231-507d723f5722.png)

通过拼接传入值和前端/Web/数据，获取文件的绝对路径。关键点在这里。这里直接使用 用户传入的值与网站前端的根目录拼接，传入的值不被检测和过滤，所以我们可以使用/跳转到任何目录，导致任意文件下载漏洞
![image](https://user-images.githubusercontent.com/54017627/168499066-69b1dc3b-6695-4b2b-9900-59111712f7f5.png)

判断文件是否存在。如果存在，请阅读文件并下载

## 2.漏洞复现

### 2.1 在当场建立良好的环境

![image](https://user-images.githubusercontent.com/54017627/168499164-b5df3ba5-8058-441d-bc57-545f0478d165.png)

### 2.2 构建POC和下载数据库配置文件

网站安装完毕后，数据库配置文件配置PHP文件在数据目录中，我们需要下载的备份文件也在数据directory_备份目录的SQL中，所以我们只需要使用/就可以跳转到数据目录

![image](https://user-images.githubusercontent.com/54017627/168499158-5b964d1b-9120-4bbf-a6cc-174016102f69.png)

poc示例:
```text
http://local.rapoo.top/admin/db/download.html?backup_name=../&file=config.php
```
### 2.3 下载文件

获取配置文件成功

![image](https://user-images.githubusercontent.com/54017627/168499133-fd61ed01-b517-42e5-8bdf-7aa2d633a612.png)

![image](https://user-images.githubusercontent.com/54017627/168499136-05cfeaaf-7f05-4ad3-8ac0-816a7d249f05.png)
