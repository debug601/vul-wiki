# ftcms存在目录遍历漏洞

供应商：http://www.ftcms.cn/

软件下载链接：http://www.ftcms.cn/skin/ftcms_v2.1.zip

影响版本：ftcms<=2.1

## 1.漏洞分析

此目录遍历漏洞原理是使用后台模板修改函数造成的。接下老，根据代码分析它是如何引起的。

首先，找到模板并修改文件代码。文件位置为admin/controllers/tp.php

```text
对应请求链接为
http://ft.rapoo.top/admin/index.php/tp/file_lists/?style=template&tp=default
```

数据库配置写入的相应方法是file_edit

```php
	//文件列表
	public  function file_lists(){
		     
			 $this->load->helper('file');//加载文件辅助函数
			 
	          $data['style'] = isset($_GET['style']) && trim($_GET['style']) ? trim($_GET['style']) : '';
			  $data['tp']=$_GET['tp'];
	  	      if($data['style']=='css'){
			       $dir="../skin/template/".$data['tp']."/";
				   $data['dir']="根目录/skin/template/".$data['tp']."/";
		      }elseif($data['style']=='template'){
			       $dir="../application/views/".$data['tp']."/";
				   $data['dir']="根目录/application/views/".$data['tp']."/";
			   }
			
	          $data['list']=get_filenames($dir,ture);//获取所有文件列表

              $this->load->vars('data',$data);
		
		      $this->load->view($this->router->class.'/file_lists');
       
     }
```

![image](https://user-images.githubusercontent.com/54017627/168746459-1549906a-d394-4149-8df4-fb22f36f2a07.png)

首先，将使用帮助类中的文件帮助程序函数

![image](https://user-images.githubusercontent.com/54017627/168746499-4f0fc7ff-09c6-4320-bd2b-522b483fcafb.png)

首先，判断两个样式参数是否在 get 请求中设置。如果是这样，请使用 trim 函数删除空格，否则它将为空。然后直接从 get 请求中获取 TP 参数。此参数尚未经过过滤和处理，这也为后续漏洞利用铺平了道路

![image](https://user-images.githubusercontent.com/54017627/168746537-ad0cfa58-1611-465e-97f4-df45fe56e3e5.png)

检查样式的值以确定是修改 CSS 文件还是模板文件。您可以随意选择

![image](https://user-images.githubusercontent.com/54017627/168746590-318b92fc-6bec-4616-afcd-4c3c205f193f.png)

然后调用get_文件名函数列出指定目录中的文件 

get_filenames函数位于帮助类中。让我们进入并分析它

![image](https://user-images.githubusercontent.com/54017627/168746672-e875f828-0f8b-402e-a4ba-23f024f01808.png)

首先，我们来看看函数的参数，$source_ Dir 表示原始路径，可以是绝对路径或相对路径，$include_ 路径的默认值为 false，默认值为 false$_ 默认值为 false

![image](https://user-images.githubusercontent.com/54017627/168746716-57bc259b-5e35-4d93-907c-d6e578fd8255.png)

首先，定义一个空数组，该数组应用于存储获取的文件名

![image](https://user-images.githubusercontent.com/54017627/168746760-5e6250a6-9fc4-4ff8-a920-94ba2ad50c4d.png)

打开指定的目录并读取其内容

![image](https://user-images.githubusercontent.com/54017627/168746796-1aeac72d-4c81-4f98-a569-1b3c82f75b2e.png)

因为$_递归默认为false，所以这里的代码会执行，也就是我们传入的路径会被处理得到真正的绝对路径，也就是说，我们可以使用/跳转到目录

![image](https://user-images.githubusercontent.com/54017627/168746850-20975843-7aa6-48cf-b5aa-3912f053378d.png)

然后，如果当前路径是文件夹，则以递归方式读取指定目录中的所有文件

![image](https://user-images.githubusercontent.com/54017627/168746926-2fd9ca26-6969-494b-b96c-c86fca882244.png)

然后将获得的文件路径分配给 $_filedata

![image](https://user-images.githubusercontent.com/54017627/168746968-562f5267-6777-4b1a-b621-f1196231fddb.png)

最后，读取文件内容显示在视图中

最终的 POC 如下所示

```text
http://ft.rapoo.top/admin/index.php/tp/file_lists/?style=template&tp=../../
```

## 2.漏洞复现

### 2.1登录

![image](https://user-images.githubusercontent.com/54017627/168747128-3aea3655-dea8-4427-81ce-1b3ce01a8279.png)

### 2.2请求POC

```text
http://ft.rapoo.top/admin/index.php/tp/file_lists/?style=template&tp=../../http://ft.rapoo.top/admin/index.php/tp/file_edit/?style=template&tp=default&file=../config.php
```

![image](https://user-images.githubusercontent.com/54017627/168747323-1fd92337-1f8c-47b7-aaa8-cc12da917177.png)

